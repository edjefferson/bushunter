<html>
  <head>
    <title>Bus Hunter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="stop_name">Bus Hunter</div>
    <div id="loading">Loading...</div>
    <table id="times"></table>
    <script>
      const queryString = window.location.search;
      const searchParams = new URLSearchParams(queryString);
      let stop_id = searchParams.get("stop_id")

      if (stop_id) {
        let timeDiff
        let stopData

        

        const updateData = () => {
          fetch(`live_update.json?stop_id=${stop_id}`).then(response => response.json()).then(data => {
            timeDiff = Date.now() - data.time_now * 1000
            stopData = data
            setTimeout(updateData,5000)


          })
        }
        const updateDisplay = () => {
          if (stopData) {
            document.getElementById("stop_name").innerHTML = stopData.stop_name + (stopData.stop_letter != "null" ? " (" + stopData.stop_letter + ")" : "")
            document.getElementById("times").innerHTML = ""
            document.getElementById("loading").style.display = "none"
            let cDate = Date.now()
            stopData.buses.forEach(d => {
              let time = document.createElement("tr")
              
              
              let projectedArrival = new Date(d.expected_arrival)
              let projected_tts = Math.floor((projectedArrival - cDate)/1000)
              if (projected_tts < 0) {
                time.classList.add("greyed")
              }
              if (projected_tts > - 60) {
                let date = new Date(d.timestamp)
                let timeString
                if (projected_tts >= 0) {
                  timeString = String(Math.floor(projected_tts/60)).padStart(2, '0') + ":" + String(Math.ceil(projected_tts % 60)).padStart(2, '0') 
                } else {
                  timeString = "-" + String(Math.floor(-projected_tts/60)).padStart(2, '0') + ":" + String(Math.ceil(-projected_tts % 60)).padStart(2, '0') 
                }
                let lineNo = document.createElement("td")
                lineNo.innerHTML = d.line_name
                time.appendChild(lineNo)

                let info = document.createElement("td")

                let dest = document.createElement("div")
                dest.innerHTML = d.destination_name
                info.appendChild(dest)

                let vid = document.createElement("div")
                vid.innerHTML = "("+ d.vehicle_id +")"
                info.appendChild(vid)
                time.appendChild(info)

                let countdown = document.createElement("td")
                countdown.innerHTML = timeString
                time.appendChild(countdown)

                let lastSeen = document.createElement("td")
                let lastSeenDesc = document.createElement("div")
                let lastSeenTime = document.createElement("div")
                lastSeenDesc.innerHTML = "Last seen: " 
                lastSeenDesc.classList.add("lsdesc")
                lastSeenTime.innerHTML = date.toLocaleTimeString({ hour12: false })
                lastSeen.appendChild(lastSeenDesc)
                lastSeen.appendChild(lastSeenTime)
                time.appendChild(lastSeen)

                document.getElementById("times").appendChild(time)
              }
              
            })
            
          } 
          requestAnimationFrame(updateDisplay)
        }
        requestAnimationFrame(updateDisplay)
        updateData()
        
      } else {

        const updateNearestStops = (position) => {
          document.getElementById("loading").style.display = "none"

          fetch(`nearby_stops.json?lat=${position.coords.latitude}&lng=${position.coords.longitude}`).then(response => response.json()).then(data => {
            document.getElementById("times").innerText = ""
            data.forEach(d => {
              document.getElementById("times").innerHTML += "<td><tr><a href='/?stop_id="+d.stop_id+"'>" + d.name + (d.stop_letter ? " - " + d.stop_letter : "") + " (" +Math.round(d.dist * 100)/100+  "km)</a><td/></tr>"
            })
          })
        }

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(updateNearestStops);
        } else {
          console.log("Geolocation is not supported by this browser.")
        } 
      }
    </script>
  </body>
</html>